## 잃어버린 시간, 인프라 자동화로 되찾다
- 김수빈, 인터널 프로덕트 팀

### 문제상황
- 팀원 증가에 따른 운영 업무 증가
- Okta, DB, 어드민, Github 등 
- 점점 늘어나는 다양한 운영 업무
- **하루 종일 운영 업무에 시달릴 수 없다**
### Okta 운영
Okta - 내부 임직원의 인증과 인가에 대한 관리, 사내 네트워크 접근 관련 관리

요구사항
- Okta 계정 잠김 -> 사용자 알림
- 사용자 관리자 모두 잠금 해제할 수 있도록

자동화
- 비밀번호 오입력, 계정 잠김 이벤트 발생 시 Slack에 Alert
	- 계정 잠김 이벤트 같은 경우에는 계정 잠김 해제 버튼을 클릭 해 자동화
### DB운영
- RDS Aurora로 운영중인 MySQL, PostgreSQL
- EC2에 배포된 MongoDB
- 한 번에 보고 관리할 필요
- 파티션, 모니터링 설정 수정
- Connection 목록 조회, 배포된 리전 조회

요구사항
- 모든 DBMS를 추상화
- DBA가 간편하게 현재 DB의 상태를 관리할 수 있도록 함

모든 리전에 배포되어있는 리소스들의 가시성 확보 -> DBMS

### 어드민 운영
- 어드민 계정 권한 관리
- 어드민 사용 권한 요청
- 권한 자동 회수의 필요성
- 더 나아가, 외부 SaaS도 함께

요구사항
- 모든 어드민 SaaS 통합, 다양한 계정 권한에 대한 신청 승인 부여 회수 할 수 있도록

- 계정 권한 신청 시 필드 직접 정의 가능
- 부여, 회수 시 Webhook을 통해 자동 부여, 자동 회수

### Github 운영
문제상황
- Github Repository 에 대한 권한 관리를 Slack을 통해 수작업을 이루어지고 있음
- Repository를 Public 으로 바꿀 시 인터널 프로덕트 팀의 작업을 거쳐야만 했음
	- 보안팀의 확인으로 취약점 확인 후 전환

### 마지막으로
- 당근의 대내외 소식을 더 쉽게 확인할 수 있는 제품
- 팀원들에게 동기 부여를 할 수 있는 제품
- 업무 효율성을 높이는 제품
- 고객 정보를 더욱 안전하게 보호하고, 안전한 제품을 만들 수 있는 기반 마련


## MongoDB on Kubernetes
- Percona Operator 와 함께 저비용 고효율 MongoDB 환경 구축

### 당근의 MongoDB
사용 환경
- 많은 클러스터 운영 <- 전체 데이터베이스 중 약 32%
- 중요 서비스의 메인 데이터베이스로 사용 중
- 신규 생성 요청이 많다.
- 스케일 작업도 자주 진행

### DocumentDB
- AWS 의 관리형 데이터베이스로, MongoDB 호환 도큐먼트 저장소
- RDS Aurora와 유사한 공유 스토리지 아키텍처
- 모든 MongoDB 기능을 제공하지 않음
- 내부 GC 프로세스의 부담, 요금 증가

### Atlas
- MongoDB의 퍼블릭 클라우드 기반 관리형 데이터베이스
- Enterprise 기능과 기술 지원
- 일부 운영 명령과 설정 사용 불가, 요금 증가

### Kubernetes 설치 검토
- 기대효과
- 우려되는 점 검토
- 도입 과정

기대 효과
- 데이터베이스 생성, 변경 자동화
- 안정적인 컴퓨트 & 스토리지 리소스 공급
- 일관된 MongoDB 토폴리지 유지

우려되는 점
- 컨테이너 실행 시 컴퓨트 성능 10% 저하(된다고 알려짐)
- 그러나 MongoDB 특성 상 IO성능이 전체 처리량에 큰 영향
- 고성능 볼륨 장착 시 벤치마킹 결과 큰 차이 없음
- 갑작스런 파드 재시작
	- 스테이트풀셋은 노드 이동으로 파드 재시작 빈도가 높지 않음
	- 그러나 클러스터 & 노드 작업 등 데이터베이스 재시작 상황이 추가
	- 대부분의 DBMS는 재시작 이벤트가 큰 영향을 미침
	- 드라이버 특성 상, MongoDB 연결 시 모든 멤버와 연결 생성
	- 일부 멤머 장애 시에도 빠르게 다른 멤버로 연결
	- 한 번 스케줄링된 노드에서 계속 실행됨
	- 노드 문제 발생하거나 스케일을 실행할 때
		- 자연스럽게 다른 노드로 이동 불가
	- 가능한 노드 이동이 필요치 않게

### 도입 과정
- Statefulset 배포
- MongoDB Community Operator
- Percona Operator
	- Percona Operator 선택

### Perocna
- psmdb ( Percona Server for MongoDB )
	- Percona의 MongoDB 프로젝트 ( 2018 )

- psmdb-operator 배포
	- CR 작성
#### 핵심 기능
- 오퍼레이터가 자동으로 MongoDB 토폴리지를 구성
- 주기적으로 데이터베이스 상태를 검사하고 사용자가 정의한대로 유지
- 오퍼레이터가 데이터베이스 변경 사항을 적용하는 전략
- Secondary 부터 하나씩, Primary 는 stepDown 실행 후 재시작
- MongoDB 클러스터를 가장 안전하게 재시작하는 방식
- Percona Backup for MongoDB 프로젝트를 임베디드
- 클라우드 스토리지 S3에 백업 저장
- 백엡 스케줄과 리스트 관리
- 일관성 있는 온라인 데이터 백업, PITR 지원
- 논리적 & 물리적 백업 유형 지원
- ALB를 이용하여 서비스 NLB 자동 생성
- NLB 주소로 EKS 외부에서 MongoDB 연결 가능
- Split Horizons 설정 제공
	-

### 사례 & 팁
- 노드 그룹 전략
	- Replica Set 멤버들은 서로 다른 노드에 분산
	- 가능한 AZ 분산
	- Anti-Affinity : hostname, zone
	- 여러 서비스 데이터베이스들이 함께 실행
	- 구성이 간단하고 관리가 편함, 리소스 Limit 설정 필요
	- 데이터베이스 각각 노드 그룹 구성 -> 프로덕션 서비스 별 격리 효과
	- 크리티컬한 서비스 데이터베이스를 관리하는데 이점이 있음
- Route53 레코드로 EndPoint 제공
	- EKS 외부에서 NLB 로 접속하는 환경
	- 데이터베이스 용 Hosted zone 생성
	- NLB 각각 A 레코드를 생성하고 이들을 나열한 SRC 레코드 생성
- PSMDB 멀티 클러스터
	- 외부 MongoDB 와 복제를 구성하는 기능
	- 다른 EKS 클러스터 혹은 외부 온프레미스 MongoDB 이관 가능
- 기존 MongoDB 클러스터 이관
- 새 버전 업그레이드 시 주의
	- 최근 메이저 버전 업그레이드에서 여러 이슈 발생
		- 1.16.0, 사용자 TLS 인증서를 반복 삭제
		- 1.15.0, 등..
- PMM 혹은 MongoDB 익스포터
	- PSMDB에 통합된 PMM 기능 사용
	- 혹은 프로메테우스 오퍼레이터와 결합한 mongodb_exporter 사용

## 궁극의 CI 환경
태초에 배포 환경이 있었다
- 당근의 개발자 플랫폼 Kontrol
	- 비용 시각화, 서비스 상태 관리, 자원 생성/ 관리, 권한 관리, 알림, 로길 모니터링

Stateless 한 환경에서의 배포
- Argo Workflows를 사용한 PIpeline를 구축
- Stateless 단점
	- 매번 환경이 생성될 때 마다 캐시도 자라지기 때문에 빌드 속도가 느려짐

Remote Cache
- 캐시를 원격에서 관리
	- Container Image 에서 발생하는 캐시를 원격에서 관리
- Kaniko, Buildkit
	- BuildKit 선택함
		- 빌드 속도가 훨씬 빠름
		- Dockerfile
			- Dockerfile의 다양한 신규 Feature들..
			- 도커 엔진 이외의 서비스들은 지원이 늦거나 안됨
		- 왜 선택했냐고..
			- BuildKit이 바로 Docker의 빌드 엔진이기 때문

비상 비상 문제 발생!
- 프로젝트 크기에 따라 빌드 소요시간이 더 오래걸림
	- 캐시 크기, 캐시 업/다운로드 시간, 캐시 준비 시간
	- 비 압축 형태로 저장된 레이어들을 선별하여 압축포맷 형태로 export
		- 시간이 너무 오래걸림
	- 캐시 히트율 문제

당근의 솔루션
- Remote Cache는 잊고 Kontrol 의 장점을 살리자
- Cache 업로드 없이 캐시를 사용할 수 있다면?
	- Stateless 한 환경의 장점을 유지하면서
		- Stateless 한 파이프라인의 장점
			- 확장이 편리하다
			- 이전 배포에 영향을 받지 않는다
	- EBS, EBS 동적 프로비저너
	- 각 프로젝트마다 각 PVC 를 붙여줌
	- Cache가 유지되는 공간만 Statefull 하게 가자.
		- /var/lib/docker/
			- image/ : 이미지 레이어의 메타데이터
			- overlay2/ : 실제 데이터
			- buildkit/ : 메타 / 실제 데이터
		- Dockerfile의 신규 피쳐
			- RUN --mount=type=cache, target=/go/pkg/mod \ go build -o /app/hello
				- Application 캐시도 유지 가능

- 최종 요약
	- 자체 개발자 플랫폼, EBS, Docker 캐시 관리 기능

성과 및 향후 Plan
기능 오픈? -> 성공적으로 오픈!

회사 전체 빌드 소요 시간 평균 30.71% 감소


좋은 기능도 잘 활용해야 빛을 발하는 법

직접 배포 시간 차이를 비교할 수 있는 지표를 제공

해결할 과제 1 - 한 프로젝트가 동시에 여러 빌드를 할 때
해결할 과제 2 - 크로스존 활용의 어려움

docker build cloud, 올해 1월 나오게 됨 빌드 대신해 주는 서비스.